{% extends 'base.html' %}
{% block content %}
<div class="max-w-4xl mx-auto">
  <div class="card mb-4">
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-xl font-semibold">Chat - Appointment #{{ appt.id }}</h2>
        <div class="text-sm text-slate-600">
          {% if current_user.role == 'doctor' %}
            with {{ patient.fullname }}
          {% else %}
            with Dr. {{ doctor.fullname }}
          {% endif %}
        </div>
      </div>
      <a href="{{ url_for('consult', appt_id=appt.id) }}" class="text-sm text-indigo-600 hover:underline">← Back to Consultation</a>
    </div>
  </div>

  <div class="card h-[600px] flex flex-col">
    <!-- Messages area -->
    <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50">
      {% for msg in messages %}
      <div class="{% if msg.sender_id == current_user.id %}text-right{% endif %}">
        <div class="inline-block max-w-xs md:max-w-md">
          <div class="text-xs text-slate-500 mb-1">
            {% set sender = doctor if msg.sender_id == appt.doctor_id else patient %}
            {{ sender.fullname }} • {{ msg.created_at.strftime('%H:%M') }}
          </div>
          <div class="{% if msg.sender_id == current_user.id %}bg-indigo-600 text-white{% else %}bg-white border{% endif %} px-4 py-2 rounded-lg">
            {{ msg.message }}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Input area -->
    <div class="border-t p-4">
      <form id="messageForm" class="flex gap-2">
        <input 
          type="text" 
          id="messageInput" 
          placeholder="Type your message..." 
          class="flex-1 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-200"
          required
        />
        <button type="submit" class="btn-primary px-6">Send</button>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
  const socket = io();
  const appointmentId = {{ appt.id }};
  const currentUserId = {{ current_user.id }};
  const messagesDiv = document.getElementById('messages');
  const messageForm = document.getElementById('messageForm');
  const messageInput = document.getElementById('messageInput');

  // Join the room
  socket.emit('join', { appointment_id: appointmentId });

  // Send message
  messageForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const message = messageInput.value.trim();
    if (message) {
      socket.emit('send_message', {
        appointment_id: appointmentId,
        message: message
      });
      messageInput.value = '';
    }
  });

  // Receive message
  socket.on('receive_message', (data) => {
    const isOwn = data.sender_id === currentUserId;
    const messageDiv = document.createElement('div');
    messageDiv.className = isOwn ? 'text-right' : '';
    messageDiv.innerHTML = `
      <div class="inline-block max-w-xs md:max-w-md">
        <div class="text-xs text-slate-500 mb-1">
          ${data.sender_name} • ${data.timestamp}
        </div>
        <div class="${isOwn ? 'bg-indigo-600 text-white' : 'bg-white border'} px-4 py-2 rounded-lg">
          ${data.message}
        </div>
      </div>
    `;
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });

  // Status updates
  socket.on('status', (data) => {
    console.log(data.msg);
  });

  // Auto-scroll to bottom
  messagesDiv.scrollTop = messagesDiv.scrollHeight;

  // Leave room on page unload
  window.addEventListener('beforeunload', () => {
    socket.emit('leave', { appointment_id: appointmentId });
  });
</script>
{% endblock %}
